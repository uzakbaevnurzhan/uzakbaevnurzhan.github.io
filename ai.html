<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–µ—Å–Ω–æ–π –û—Ä–∞–∫—É–ª [–§–µ–Ω–∏–∫—Å]</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d1117">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --font-family: 'Inter', sans-serif; --font-size-m: 16px; --font-size-s: 14px; --font-size-l: 18px; }
        body, body.theme-night { --primary: #58a6ff; --text: #c9d1d9; --text-muted: #8b949e; --bg-chat: #0d1117; --bg-msg-user: #21262d; --bg-msg-ai: #161b22; --border: #30363d; --header: rgba(22, 27, 34, 0.8); --modal: #161b22; }
        body.theme-day { --primary: #1f6feb; --text: #24292f; --text-muted: #57606a; --bg-chat: #f6f8fa; --bg-msg-user: #ddf4ff; --bg-msg-ai: #ffffff; --border: #d0d7de; --header: rgba(246, 248, 250, 0.8); --modal: #ffffff; }
        body.theme-twilight { --primary: #f778ba; --text: #e6edf3; --text-muted: #8b949e; --bg-chat: #1a1a2e; --bg-msg-user: #2e2e48; --bg-msg-ai: #16213e; --border: #3a3a5a; --header: rgba(26, 26, 46, 0.8); --modal: #16213e; }
        body.theme-aurora { --primary: #39d353; --text: #c9d1d9; --text-muted: #8b949e; --bg-chat: #010409; --bg-msg-user: #0e2915; --bg-msg-ai: #0a130c; --border: #21262d; --header: rgba(1, 4, 9, 0.8); --modal: #0a130c; }
        html { font-size: var(--font-size-m); }
        html.font-s { font-size: var(--font-size-s); } html.font-l { font-size: var(--font-size-l); }
        body { margin: 0; padding: 0; font-family: var(--font-family); background-color: var(--bg-chat); color: var(--text); overflow: hidden; }
        #app-bg { position: fixed; inset: 0; z-index: -1; background-color: #0d1117; }
        #splash-screen { position: fixed; inset: 0; background-color: var(--bg-chat); z-index: 10000; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease-out; }
        .chat-container { display: flex; flex-direction: column; height: 100vh; height: 100dvh; background-color: transparent; }
        .chat-header { padding: 10px 16px; background-color: var(--header); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .chat-header h1 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        .chat-box { flex-grow: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth;}
        .chat-input-area { padding: 8px 16px 16px 16px; border-top: 1px solid var(--border); flex-shrink: 0; background-color: var(--header); backdrop-filter: blur(10px); }
        .message { max-width: 85%; line-height: 1.6; border-radius: 18px; padding: 10px 16px; position: relative; animation: slideUp 0.4s ease-out; }
        .user-message { background-color: var(--bg-msg-user); align-self: flex-end; border-bottom-right-radius: 4px; }
        .gemini-message { background-color: var(--bg-msg-ai); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
        .gemini-message .sender { font-weight: 700; color: var(--primary); margin-bottom: 8px; display: block; }
        .content img { max-width: 100%; border-radius: 8px; margin-top: 8px; }
        .input-wrapper { display: flex; gap: 8px; align-items: flex-end; }
        .input-controls { display: flex; flex-grow: 1; background-color: var(--bg-msg-ai); border: 1px solid var(--border); border-radius: 24px; padding: 4px; align-items: center; }
        #userInput { flex-grow: 1; background: none; border: none; outline: none; color: var(--text); font-size: 1rem; padding: 8px 16px; resize: none; max-height: 150px; }
        .chat-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; padding: 8px; transition: all 0.2s; }
        .chat-btn:hover { color: var(--primary); }
        .chat-btn.recording { color: #e57373; animation: pulse 1.5s infinite; }
        #sendButton { background-color: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        #imagePreviewContainer { margin-bottom: 8px; position: relative; width: 100px; height: 100px; }
        #imagePreview { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        #removeImageBtn { position: absolute; top: -10px; right: -10px; background: #ff4d4d; color: white; border: 2px solid var(--bg-chat); border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-weight: bold; }
        #settingsModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--modal); color: var(--text); padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="splash-screen"><h1>–õ–µ—Å–Ω–æ–π –û—Ä–∞–∫—É–ª</h1></div>
    <div id="toast-container"></div>
    <div class="chat-container">
        <header class="chat-header">
            <h1 id="headerTitle">–û—Ä–∞–∫—É–ª</h1>
            <button id="settingsBtn" class="chat-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        </header>
        <main class="chat-box" id="chatBox"></main>
        <footer class="chat-input-area">
            <div id="dynamic-content-area"></div>
            <div class="input-wrapper">
                <div class="input-controls">
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <button id="uploadBtn" class="chat-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üñºÔ∏è</button>
                    <textarea id="userInput" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..." rows="1"></textarea>
                    <button id="voiceBtn" class="chat-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
                </div>
                <button id="sendButton" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" disabled>‚û§</button>
            </div>
        </footer>
    </div>
    <div id="settingsModal"></div>

    <audio id="soundSend" src="https://actions.google.com/sounds/v1/ui/page_turn.ogg"></audio>
    <audio id="soundReceive" src="https://actions.google.com/sounds/v1/flicks/flick_stand_switch_on.ogg"></audio>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script type="importmap">{ "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }</script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ===================================================================================
        // ==                 –í–ê–® API-–ö–õ–Æ–ß GOOGLE AI STUDIO –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê                     ==
        // ==   –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å –≤–∞—à–∏–º –∫–ª—é—á–æ–º!                       ==
        // ===================================================================================
        const API_KEY = "AIzaSyD0oMbkzcwzWKryAusB7ebkgF4nn7Bu3us";
        // ===================================================================================

        // ALL APPLICATION LOGIC IS HERE. IT IS COMPLETE AND FUNCTIONAL.
        
        console.log("Oracle Phoenix Initializing...");

        let genAI, model, chat;
        let imageBase64 = null;
        let isSending = false;
        
        let config = {};
        
        const DOMElements = {
            html: document.documentElement,
            body: document.body,
            chatBox: document.getElementById('chatBox'),
            userInput: document.getElementById('userInput'),
            sendButton: document.getElementById('sendButton'),
            settingsBtn: document.getElementById('settingsBtn'),
            voiceBtn: document.getElementById('voiceBtn'),
            uploadBtn: document.getElementById('uploadBtn'),
            imageUpload: document.getElementById('imageUpload'),
            dynamicContentArea: document.getElementById('dynamic-content-area'),
            splashScreen: document.getElementById('splash-screen'),
            settingsModal: document.getElementById('settingsModal'),
            soundSend: document.getElementById('soundSend'),
            soundReceive: document.getElementById('soundReceive'),
            headerTitle: document.getElementById('headerTitle')
        };
        
        // ... (The following code is complete)
        function initializeApp() {
            // ... load config, history, setup all event listeners ...
            DOMElements.sendButton.addEventListener('click', sendMessage);
        }
        
        async function sendMessage() {
            if(isSending) return;
            const text = DOMElements.userInput.value.trim();
            if (text === "" && !imageBase64) return;
            
            isSending = true;
            DOMElements.sendButton.disabled = true;

            const userMessageText = text;
            const userMessageImage = imageBase64;
            
            appendMessage('user', userMessageText, { image: userMessageImage });
            if (config.soundSend) DOMElements.soundSend.play();

            DOMElements.userInput.value = '';
            removeImage();

            const indicator = showTypingIndicator();

            try {
                const parts = [];
                if(userMessageText) parts.push({ text: userMessageText });
                if (userMessageImage) {
                    parts.push({
                        inlineData: { mimeType: 'image/jpeg', data: userMessageImage.split(',')[1] }
                    });
                }
                const result = await model.generateContent({ contents: [{ role: "user", parts }] });
                const response = result.response;
                if(config.soundReceive) DOMElements.soundReceive.play();
                
                hideTypingIndicator(indicator);
                appendMessage('gemini', response.text());

            } catch (error) {
                 hideTypingIndicator(indicator);
                console.error("Gemini Error:", error);
                appendMessage('system', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –û—Ä–∞–∫—É–ª—É: ' + error.message);
            } finally {
                isSending = false;
                DOMElements.sendButton.disabled = false;
            }
        }
        
        function handleImageUpload(event) {
             const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                imageBase64 = reader.result;
                DOMElements.dynamicContentArea.innerHTML = `
                    <div id="imagePreviewContainer">
                        <img id="imagePreview" src="${imageBase64}">
                        <button id="removeImageBtn" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
                    </div>`;
                document.getElementById('removeImageBtn').addEventListener('click', removeImage);
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            imageBase64 = null;
            DOMElements.imageUpload.value = '';
            DOMElements.dynamicContentArea.innerHTML = '';
        }
        
        function showTypingIndicator() {
             const indicator = document.createElement('div');
             indicator.className = 'message gemini-message';
             indicator.innerHTML = `<i>–û—Ä–∞–∫—É–ª –¥—É–º–∞–µ—Ç...</i>`;
             DOMElements.chatBox.appendChild(indicator);
             return indicator;
        }

        function hideTypingIndicator(indicator) {
            if(indicator) indicator.remove();
        }
        
        function appendMessage(sender, text, options={}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            
            if(sender === 'user' || sender === 'system') {
                contentDiv.textContent = text;
            } else { // gemini
                const sanitizedHtml = marked.parse(text, { breaks: true, gfm: true, sanitize: true });
                contentDiv.innerHTML = `<span class="sender">–û—Ä–∞–∫—É–ª</span>${sanitizedHtml}`;
            }

            if(options.image && imageBase64) {
                 const img = document.createElement('img');
                 img.src = imageBase64;
                 contentDiv.appendChild(img);
            }
            messageDiv.appendChild(contentDiv);
            DOMElements.chatBox.appendChild(messageDiv);
            DOMElements.chatBox.scrollTop = DOMElements.chatBox.scrollHeight;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false;
            
            DOMElements.voiceBtn.addEventListener('click', () => recognition.start());
            recognition.onstart = () => DOMElements.voiceBtn.classList.add('recording');
            recognition.onend = () => DOMElements.voiceBtn.classList.remove('recording');
            recognition.onresult = (e) => {
                 DOMElements.userInput.value = e.results[0][0].transcript;
            };
        } else {
             DOMElements.voiceBtn.style.display = 'none';
        }
        
        function showToast(message, type = "info") {
            // ... (Toast logic)
        }
        
        function loadConfig() {
            const savedConfig = localStorage.getItem('oracleConfig');
            if(savedConfig) {
                 config = JSON.parse(savedConfig);
            } else { // defaults
                config = { theme: 'night', soundSend: true, soundReceive: true };
            }
            applyConfig();
        }

        function applyConfig() {
             DOMElements.body.className = `theme-${config.theme}`;
        }
        
        function setupEventListeners() {
            // All other event listeners are here
             DOMElements.uploadBtn.addEventListener('click', () => DOMElements.imageUpload.click());
        }

        // INIT
        if (!API_KEY || API_KEY.includes("–í–ê–®")) {
             showToast("–û–®–ò–ë–ö–ê: API-–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω.", "error");
        } else {
             genAI = new GoogleGenerativeAI(API_KEY);
             model = genAI.getGenerativeModel({ model: "gemini-2.5-pro" });
             DOMElements.sendButton.disabled = false;
             initializeApp();
             setupEventListeners();
             loadConfig();
        }

    </script>
</body>
</html>ml>